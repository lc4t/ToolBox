<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <style>
        /* 基础样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        /* 容器样式 */
        .container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        /* 标题区域 */
        .header {
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin: -30px -30px 30px -30px;
        }
        
        /* 数据卡片网格 */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        /* 数据卡片 */
        .metric-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* 表格样式 */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #1a73e8;
            white-space: nowrap;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        /* 信号标签 */
        .signal {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        .signal-buy {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .signal-sell {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .signal-observe {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        /* 数值颜色 */
        .positive {
            color: #2e7d32;
            font-weight: 600;
        }
        
        .negative {
            color: #c62828;
            font-weight: 600;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 15px;
                margin: -15px -15px 20px -15px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 10px;
            }
        }
        
        .tooltip {
            display: none;
            position: absolute;
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.8em;
            max-width: 250px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .metric-label {
            position: relative;
            cursor: help;
        }
        
        .metric-label:hover .tooltip {
            display: block;
        }
    </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h2>【{{ result.next_signal.action }}】{{
                    result.symbol_info.get('name', '') }}({{ result.symbol }}) -
                    {{ result.end_date.strftime('%Y-%m-%d') }}</h2>
                <p>{{ result.start_date.strftime('%Y-%m-%d') }} 至 {{
                    result.end_date.strftime('%Y-%m-%d') }}</p>
            </div>

            <div class="section">
                <div class="section-title">最新信号</div>
                <div class="metric-card">
                    <div class="metric-label">操作建议</div>
                    <div
                        class="signal {{ 'signal-buy' if result.next_signal.action == '买入' else 'signal-sell' if result.next_signal.action == '卖出' else 'signal-observe' }}">
                        {{ result.next_signal.action }}
                    </div>
                    {% if result.next_signal.conditions %}
                    <div class="metric-label"
                        style="margin-top: 10px;">触发条件</div>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        {% for condition in result.next_signal.conditions %}
                        <li>{{ condition }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    {% if result.next_signal.stop_loss %}
                    <div class="metric-label"
                        style="margin-top: 10px;">止损价</div>
                    <div class="metric-value">{{
                        "{:.3f}".format(result.next_signal.stop_loss) }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="section">
                <div class="section-title">基本信息</div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">初始资金</div>
                        <div class="metric-value">¥{{
                            "{:,.2f}".format(result.initial_capital) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">最终权益</div>
                        <div class="metric-value">¥{{
                            "{:,.2f}".format(result.final_value) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">总收益率</div>
                        <div
                            class="metric-value {{ 'positive' if result.total_return > 0 else 'negative' }}">
                            {{ "{:+.2f}%".format(result.total_return) }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">性能指标</div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">夏普比率</div>
                        <div class="metric-value">{{
                            "{:.2f}".format(result.sharpe_ratio) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">最大回撤</div>
                        <div class="metric-value">{{
                            "{:.2f}%".format(result.max_drawdown) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">总交易次数</div>
                        <div class="metric-value">{{ result.total_trades
                            }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">胜率</div>
                        <div class="metric-value">{{
                            "{:.2f}%".format(result.win_rate) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">平均盈利</div>
                        <div
                            class="metric-value {{ 'positive' if result.avg_win else '' }}">
                            {{ "{:.2f}".format(result.avg_win) if result.avg_win
                            else 'N/A' }}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">平均亏损</div>
                        <div
                            class="metric-value {{ 'negative' if result.avg_loss else '' }}">
                            {{ "{:.2f}".format(result.avg_loss) if
                            result.avg_loss else 'N/A' }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">风险指标</div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">
                            夏普比率
                            <div
                                class="tooltip">衡量投资组合的超额回报与风险的比率。大于1表现优秀，小于0表现不佳。</div>
                        </div>
                        <div class="metric-value">{{
                            "{:.2f}".format(result.metrics.get('sharpe_ratio',
                            0)) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            Calmar比率
                            <div
                                class="tooltip">年化收益率与最大回撤的比值，反映收益与风险的平衡。大于1表示表现良好。</div>
                        </div>
                        <div class="metric-value">{{
                            "{:.2f}".format(result.metrics.get('calmar_ratio',
                            0)) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            当前回撤
                            <div class="tooltip">当前净值距离历史最高点的跌幅。</div>
                        </div>
                        <div
                            class="metric-value {{ 'negative' if result.metrics.get('current_drawdown', 0) < 0 else '' }}">
                            {{
                            "{:.2f}%".format(result.metrics.get('current_drawdown',
                            0)) }}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            最大回撤
                            <div
                                class="tooltip">历史最大的净值回撤幅度，反映策略的风险承受能力。越小越好。</div>
                        </div>
                        <div class="metric-value">{{
                            "{:.2f}%".format(result.metrics.get('max_drawdown',
                            0)) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            VWR指标
                            <div
                                class="tooltip">波动率加权收益率，综合考虑收益和风险。通常大于5较好。</div>
                        </div>
                        <div class="metric-value">{{
                            "{:.2f}".format(result.metrics.get('vwr', 0))
                            }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            SQN指标
                            <div
                                class="tooltip">系统质量指数，衡量交易系统的稳定性。大于2表示良好，大于3表示优秀。</div>
                        </div>
                        <div class="metric-value">{{
                            "{:.2f}".format(result.metrics.get('sqn', 0))
                            }}</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">核心指标</div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">
                            年化收益率
                            <div class="tooltip">将总收益率换算成年化收益率，便于与其他投资品比较。</div>
                        </div>
                        <div
                            class="metric-value {{ 'positive' if result.metrics.get('annual_return', 0) > 0 else 'negative' }}">
                            {{
                            "{:+.2f}%".format(result.metrics.get('annual_return',
                            0)) }}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            盈亏比
                            <div class="tooltip">平均盈利与平均亏损的比值。通常大于2.0较好。</div>
                        </div>
                        <div class="metric-value">{{
                            "{:.2f}".format(result.metrics.get('profit_factor',
                            0)) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            日均交易次数
                            <div class="tooltip">反映策略的交易频率，需要与手续费成本结合考虑。</div>
                        </div>
                        <div class="metric-value">{{
                            "{:.2f}".format(result.metrics.get('trades_per_day',
                            0)) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            最大连续盈利次数
                            <div class="tooltip">反映策略在顺势时的稳定性。</div>
                        </div>
                        <div class="metric-value">{{
                            result.metrics.get('max_consecutive_wins', 0)
                            }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            最大连续亏损次数
                            <div class="tooltip">反映策略在逆势时的抗风险能力。</div>
                        </div>
                        <div class="metric-value">{{
                            result.metrics.get('max_consecutive_losses', 0)
                            }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            平均持仓时间
                            <div class="tooltip">反映策略的持仓周期，与策略类型相关。</div>
                        </div>
                        <div class="metric-value">{{
                            result.metrics.get('avg_holding_period', '0天')
                            }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            最新净值
                            <div class="tooltip">当前策略净值，反映投资组合的当前价值。</div>
                        </div>
                        <div class="metric-value">{{
                            "{:.2f}".format(result.metrics.get('latest_nav', 0))
                            }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            年复合收益率
                            <div class="tooltip">考虑复利效应的年化收益率，更准确反映长期收益能力。</div>
                        </div>
                        <div
                            class="metric-value {{ 'positive' if result.metrics.get('cagr', 0) > 0 else 'negative' }}">
                            {{ "{:+.2f}%".format(result.metrics.get('cagr', 0))
                            }}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            运行天数
                            <div class="tooltip">策略运行的总天数，反映策略的稳定性和可靠性。</div>
                        </div>
                        <div class="metric-value">{{
                            result.metrics.get('running_days', 0) }}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            建仓日期
                            <div class="tooltip">策略开始运行的日期。</div>
                        </div>
                        <div class="metric-value">
                            {% if result.metrics.get('start_date') %}
                            {% if result.metrics.get('start_date') is string %}
                            {{ result.metrics.get('start_date') }}
                            {% else %}
                            {{
                            result.metrics.get('start_date').strftime('%Y-%m-%d')
                            }}
                            {% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">
                            更新日期
                            <div class="tooltip">最近一次更新数据的日期。</div>
                        </div>
                        <div class="metric-value">
                            {% if result.metrics.get('update_date') %}
                            {% if result.metrics.get('update_date') is string %}
                            {{ result.metrics.get('update_date') }}
                            {% else %}
                            {{
                            result.metrics.get('update_date').strftime('%Y-%m-%d')
                            }}
                            {% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">最近交易记录</div>
                <table>
                    <tr>
                        <th>日期</th>
                        <th>操作</th>
                        <th>价格</th>
                        <th>数量</th>
                        <th>交易金额</th>
                        <th>手续费</th>
                        <th>盈亏</th>
                        <th>总资产</th>
                        <th>信号原因</th>
                    </tr>
                    {% for trade in result.trades[-20:] %}
                    <tr>
                        <td>{{ trade.date.strftime('%Y-%m-%d') if trade.date is
                            not string else trade.date }}</td>
                        <td>
                            <span
                                class="signal {{ 'signal-buy' if trade.action == 'BUY' else 'signal-sell' }}">
                                {{ trade.action }}
                            </span>
                        </td>
                        <td>{{ "{:.3f}".format(trade.price) }}</td>
                        <td>{{ trade.size }}</td>
                        <td>{{ "{:,.2f}".format(trade.value) }}</td>
                        <td>{{ "{:.2f}".format(trade.commission) }}</td>
                        <td
                            class="{{ 'positive' if trade.pnl > 0 else 'negative' if trade.pnl < 0 else '' }}">
                            {{ "{:+.2f}".format(trade.pnl) if trade.pnl != 0
                            else "0.00" }}
                        </td>
                        <td>{{ "{:,.2f}".format(trade.total_value) }}</td>
                        <td>{{ trade.signal_reason }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>

            <div class="section">
                <div class="section-title">策略参数</div>
                <table>
                    <tr>
                        <th>参数</th>
                        <th>值</th>
                    </tr>
                    {% for key, value in result.strategy_params.items() %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>{{ value }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </body>
</html>